---
title: "Data for: "
author: "Nicholas S. Marzolf"
date: "Updated March 13, 2023"
output: 
  pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

RMarkdown file to accompany *On the breakdown of woody debris across a groundwater gradient in Neotropical streams, Costa Rica,* submitted to the journal *Freshwater Science.*

To recreate this HTML, load the data files into a folder named 'Data' at the same path as the .rmd file, open the .rmd file, and click 'Knit'.

# Load packages

```{r load-packages, echo = TRUE, message=FALSE, warning = FALSE}
# data manipulation
library(tidyverse)
library(readxl)
library(dplyr)
library(forcats)
library(purrr)

# plotting
library(ggplot2)
library(ggeffects)
library(grid)
library(ggpubr)
library(ggrepel)
library(ggcorrplot)
library(lemon)
source('C:/Users/Nick Marzolf/Desktop/Research/R code/theme_nick.R')
theme_set(theme_nick())

# statistics
library(car)
library(drc)
library(nlme)
library(nlstools)
library(qpcR)

# spatial
library(sf)
library(raster)
library(spData)
library(tmap)
library(leaflet)
library(spDataLarge)

# community
library(vegan)
library(pander)
library(lattice)
library(permute)

```

# Load data

```{r load-data, warning=FALSE, echo=TRUE}
chem <- readxl::read_excel('Data/LT_CWD_datasheet.xlsx',
                           sheet = 'Chemistry') 

cwd <- readxl::read_excel('Data/LT_CWD_datasheet.xlsx',
                          sheet = 'Sheet1')

table_s1 <- readxl::read_excel('Data/LT_CWD_datasheet.xlsx',
                               sheet = 'Wood Morphology')
readr::write_csv(table_s1,
                 'Data/table_s1.csv')
```

# Stream chemistry for 5 sites

```{r chemistry, warning=FALSE, echo=TRUE}
chem <- chem %>% 
  dplyr::rename(site = 'Site',
                srp = `SRP (ug/L)`,
                no3_n = `NO3-N (ug/L)`,
                nh4_n = `NH4-N (ug/L)`)

# calculate mean of all measurements
chem_sum <- chem %>% 
  dplyr::group_by(site) %>%
  dplyr::summarise(dplyr::across(.cols = 2:7,
                                 .fns = mean, 
                                 na.rm = TRUE))

# calculate SD from stream chemistry data
chem_sd <- chem %>% 
  dplyr::group_by(site) %>%
  dplyr::summarise(dplyr::across(.cols = 2:7,
                                 .fns = sd, 
                                 na.rm = TRUE))

# create object that sorts sites by decreasing mean conductivity
sites <- chem_sum %>%
  dplyr::group_by(site) %>%
  dplyr::summarise(mean_cond = mean(Cond, na.rm = TRUE)) %>%
  dplyr::arrange(desc(mean_cond)) 

# create a characeter vector of sites in order
sites <- as.character(sites$site)

# create a vector for longer names used in plotting
sites_long <- c(`Arb` = 'Arboleda 30',
                `Sur30` = 'Sura 30',
                `Tito60` = 'Saltito 60',
                `Piper` = 'Piper',
                `Tac` = 'Taconazo 30')


# calculate DIN and N:P ratio
chem_sum <- chem_sum %>%
  dplyr::mutate(din = no3_n + nh4_n,
                n_p = (din/14.0067)/(srp/30.973762))


# re-level the site factor
chem_sum$site <- forcats::fct_relevel(chem_sum$site,
                                      sites)

table1 <- dplyr::arrange(chem_sum, 
                         desc(Cond))
table1
```

# Figure 1: Map

```{r map, warning=FALSE, echo=TRUE}
streams_gps <- readr::read_csv('C:/Users/Nick Marzolf/Desktop/NCSU/STREAMS/La Selva GIS data/LTREB Data/GPS sites.csv')


cwd_coords <- streams_gps %>% 
  dplyr::filter(Site %in% sites_long) %>% 
  sf::st_as_sf(., 
               coords = c('Long', 'Lat'),
               crs = st_crs(4326))

cwd_coords$Site <- forcats::fct_relevel(cwd_coords$Site,
                                        c('Arboleda 30', 'Sura 30', 'Saltito 60',
                                          'Piper', 'Taconazo 30'))

# La Selva boundary
lsbs <- sf::st_read(dsn = 'Data/Spatial/laselvaboundary.shp')

# Streams at La Selva shapefile
streams <- sf::st_read(dsn = 'Data/Spatial/streamsclip.shp')


cr <- world %>%
  dplyr::filter(name_long == 'Costa Rica')

# make a basic map of Costa Rica
cr_map <- tmap::tm_shape(cr)+   # create shape based on Costa Rica object
  tmap::tm_polygons()+          # add cr as a polygon
  tmap::tm_shape(lsbs)+         # create shape for the boundary of La Selva
  tmap::tm_dots(size = 1)       # add lsbs as a dot
cr_map


# La Selva boundary and stream layer ----

# Create a map of La Selva boundary and the stream network
map_lsbs <- tmap::tm_shape(lsbs)+            # new shape: La Selva boundary
  tmap::tm_borders()+                        # add as a border/line layer
  tmap::tm_shape(streams)+                   # new shape: stream network
  tmap::tm_lines(col = 'blue')+              # add as a line, colored blue
  tmap::tm_scale_bar(breaks = c(0, 1, 2),    # add a scale bar, with demarkations for 0, 1, and 2 km
                     text.size = 0.75,       # change text size
                     position = c('left',    # put the scale bar in the bottom left
                                  'bottom'))
map_lsbs


fig1 <- tmap::tm_shape(lsbs)+                   # create La Selva boundary layer
  tmap::tm_borders(col = 'black')+
  tmap::tm_shape(streams)+                              # create stream network layer
  tmap::tm_lines(col = 'blue')+
  tmap::tm_shape(cwd_coords)+                             # map the locations of pH sites
  tmap::tm_symbols(size = 1,                            # change the size
                   col = 'Site',                        # colored by site name
                   border.col = 'black',                # with black boundary color
                   palette = "viridis", n = 5)+         # change the color palette
  tmap::tm_scale_bar(breaks = c(0, 1, 2),               # add scale bar
                     text.size = 0.75,
                     position = c('left', 'bottom'))+
  tmap::tm_layout(inner.margins = c(.15,.01, .01, .4),  # change the margins to fit the legend and inset map
                  legend.position = c('right', 'top'),
                  legend.frame = TRUE)+
  tmap::tm_compass(position = c('left', 'top'))+        # add compass north star
  tmap::tm_grid(projection = 4326,
                labels.inside.frame = FALSE,
                lines = FALSE)
fig1

tmap_save(tm = fig1,
          filename = 'Figures/fig1.png', 
          dpi = 600, 
          width = 4, height = 4)
```

# Calculate wood decomposition rates

```{r kCWD, warning=FALSE, echo=TRUE}
# begin cleaning data
cwd <- cwd %>% 
  dplyr::filter(Flag == 0) %>%
  dplyr::select(site = Site, 
                month = `Collection Month`,
                rep = Rep,
                init_mass = `initial CWD mass (g)`,
                dry_mass = `CWD Pack Dry Mass (g)`,
                init_den = `init wood density (g/cm3)`,
                fin_den = `final wood density (g/cm3)`) %>%
  dplyr::filter(month < 24)

# re-level site factor based on conductivity
cwd$site <- forcats::fct_relevel(cwd$site, 
                                 sites)

# calculate % dry mass remaining
cwd_calc <- cwd %>%
  dplyr::filter(site != 'Sac') %>%
  dplyr::mutate(percent_mass = (dry_mass/init_mass)*100)

# dry mass of each pack to be used in the bug analysis
final_dry_mass <- cwd_calc %>% 
  dplyr::select(site, month, rep, dry_mass) %>% 
  dplyr::filter(month != 0)

# calculate decay rates using ANCOVA
k_cwd_int <- lm(data = cwd_calc,
                log(percent_mass) ~ month * site)

summary(k_cwd_int)
anova(k_cwd_int)
car::Anova(k_cwd_int, type = 'III')

table2 <- cwd_calc %>%
  dplyr::filter(site != 'Sac') %>%
  dplyr::group_by(site) %>%
  dplyr::summarise(
    int = round((coef(lm(log(percent_mass) ~ month))[1]), 3),
    k_yr = (round((coef(lm(log(percent_mass) ~ month))[2])*12, 3))*-1,
    error = summary(lm(log(percent_mass) ~ month))$coefficient[3],
    #df = summary(lm(log(percent_mass) ~ month))$fstatistic,
    r2 = round(summary(lm(log(percent_mass) ~ month))$r.squared, 2),
    p = anova(lm(log(percent_mass) ~ month))$'Pr(>F'[1])
table2


fig2 <- ggplot(data = cwd_calc,
               aes(y = log(percent_mass),
                   x = month))+
  geom_point(aes(color = site))+
  geom_smooth(aes(color = site),
              method = 'lm',se = FALSE)+
  lims(y = c(3.4, 5))+
  geom_label(data = table2 %>% 
               dplyr::select(site, k_yr),
             aes(x = 2.5, y = 3.7,
                 label = paste0('k = ',k_yr)))+
  geom_label(data = table2 %>% 
               dplyr::select(site, r2),
             aes(x = 2.5, y = 3.45,
                 label = paste0('R2 = ',r2)))+
  facet_grid(. ~ site, 
             labeller = as_labeller(sites_long))+
  labs(x = 'Months',
       y = 'ln(% DM Remaining)')+
  scale_color_viridis_d()+
  scale_x_continuous(breaks = c(0, 1, 3, 6, 12))+
  theme(legend.position = 'none')
fig2

ggsave(plot = fig2, 
       'Figures/fig2.png',
       dpi = 600, 
       width = 10,height = 3)

cwd_calc %>% 
  group_by(site, month) %>% 
  summarise(mean_per_mass = mean(percent_mass, na.rm = TRUE))

```

# Merge chemistry with decay rates

```{r decay-chemistry, warning=FALSE, echo=TRUE}
merged <- table2 %>%
  dplyr::select(site, k_yr, error) %>% 
  dplyr::right_join(chem_sum, 'site') %>%
  dplyr::select(-Temp) %>%
  tidyr::pivot_longer(srp:n_p)

names_long <- c(`Cond` = 'Conductivity (µS/cm)',
                `din` = 'DIN (µg/L)',
                `n_p` = 'DIN:SRP',
                `nh4_n` = 'NH4-N (µg/L)',
                `no3_n` = 'NO3-N (µg/L)',
                `pH` = 'pH',
                `srp` = 'SRP (µg/L)')

wide <- table2 %>%
  dplyr::select(site, k_yr, error) %>% 
  dplyr::right_join(chem_sum, 'site') %>%
  dplyr::select(-Temp)

cor <- cor(wide %>% 
             dplyr::select(-site, -error) %>% 
             mutate_if(is.character, as.numeric), 
           method = 'spearman')

cor_sub <- cor[-c(2:nrow(cor)), 2:ncol(cor),drop = FALSE]
rownames(cor_sub)[1] <- 'k_yr'
colnames(cor_sub)[1:7] <- c('SRP', 'NO3-N', 'NH4-N', 'pH', 'Cond', 'DIN', 'DIN:SRP')

pmat <- ggcorrplot::cor_pmat(cor,
                 'spearman', alternative = 'two.sided')
pmat_sub <- pmat[-c(2:nrow(pmat)), 2:ncol(pmat),drop = FALSE]

ggcorrplot(cor_sub, lab = TRUE,
           ggtheme = theme_nick(),show.legend = FALSE,p.mat = pmat_sub)



```

<!-- ## Run linear and non-linear models of kCWD ~ chemistry -->

<!-- ```{r linear-mods, warning=FALSE, echo=TRUE} -->

<!-- vars <- unique(merged$name) -->

<!-- # linear: Y ~ a + bX -->

<!-- # create empty dataframe to populate in the for loop -->

<!-- linear <- data.frame(mod = character(), -->

<!--                      var = character(), -->

<!--                      a = numeric(), -->

<!--                      a_2.5 = numeric(), -->

<!--                      a_97.5 = numeric(), -->

<!--                      b = numeric(), -->

<!--                      b_2.5 = numeric(), -->

<!--                      b_97.5 = numeric(), -->

<!--                      AIC = numeric(), -->

<!--                      p = numeric(), -->

<!--                      rse = numeric(), -->

<!--                      df = numeric()) -->

<!-- # for loop across each parameter -->

<!-- for(i in 1:length(vars)){ -->

<!--   # which var is being predicted -->

<!--   var <- vars[i] -->

<!--   # run the lm of k ~ chemistry -->

<!--   lm <- lm(data = merged %>% -->

<!--              filter(name == var), -->

<!--            k_yr ~ value) -->

<!--   # populate the empty data frame -->

<!--   linear <- linear %>%  -->

<!--     add_row( -->

<!--       mod = 'Linear',                    # what kind of model -->

<!--       var = var,                         # for which variable -->

<!--       a = coef(lm)[1],                   # intercept -->

<!--       a_2.5 = confint(lm)[1,1],          # intercept low CI -->

<!--       a_97.5 = confint(lm)[1,2],         # intercept high CI -->

<!--       b = coef(lm)[2],                   # slope -->

<!--       b_2.5 = confint(lm)[2,1],          # slope low CI -->

<!--       b_97.5 = confint(lm)[2,2],         # slope high CI -->

<!--       AIC = AIC(lm),                     # model AIC -->

<!--       p = summary(lm)$coefficients[2,4], # p value -->

<!--       rse = summary(lm)$sigma,           # RSE -->

<!--       df = summary(lm)$df[2]             # df -->

<!--     ) -->

<!-- } -->

<!-- ``` -->

<!-- ```{r Mic-Men-mods, warning=FALSE, echo=TRUE} -->

<!-- # empty data frame -->

<!-- micmen <- data.frame(mod = character(), -->

<!--                      fit = character(), -->

<!--                      var = character(), -->

<!--                      a = numeric(), -->

<!--                      a_2.5 = numeric(), -->

<!--                      a_97.5 = numeric(), -->

<!--                      b = numeric(), -->

<!--                      b_2.5 = numeric(), -->

<!--                      b_97.5 = numeric(), -->

<!--                      AIC = numeric(), -->

<!--                      p = numeric()) -->

<!-- # for loop for each variable -->

<!-- for(i in 1:length(vars)) { -->

<!--   var <- vars[i] -->

<!--   mm_mod <- try(nls(data = merged %>%  -->

<!--                       filter(name == var), -->

<!--                     k_yr ~ SSmicmen(value, a, b)) -->

<!--   ) -->

<!--   # fault tolerance, won't work for every parameter -->

<!--   if(inherits(mm_mod, 'try-error')){ -->

<!--     micmen <- micmen %>%  -->

<!--       add_row(fit = 'error', -->

<!--               var = var, -->

<!--               mod = 'Michaelis-Menten') -->

<!--     next -->

<!--   } -->

<!--   # populate the data frame -->

<!--   micmen <- micmen %>%  -->

<!--     add_row( -->

<!--       mod = 'Michaelis-Menten', -->

<!--       fit = 'success', -->

<!--       var = var, -->

<!--       a = coef(mm_mod)[1], -->

<!--       a_2.5 = confint2(mm_mod, level = 0.95)['a',1], -->

<!--       a_97.5 = confint2(mm_mod, level = 0.95)['a',2], -->

<!--       b = coef(mm_mod)[2], -->

<!--       b_2.5 = confint2(mm_mod, level = 0.95)['b',1], -->

<!--       b_97.5 = confint2(mm_mod, level = 0.95)['b',2], -->

<!--       AIC = AIC(mm_mod), -->

<!--       p = summary(mm_mod)$coefficients[8] -->

<!--     ) -->

<!-- } -->

<!-- ``` -->

<!-- ```{r logarithmic, warning=FALSE, echo=TRUE} -->

<!-- ## Logarithmic: Y ~ a + b*log(X) -->

<!-- logarithmic <- data.frame(mod = character(), -->

<!--                           var = character(), -->

<!--                           a = numeric(), -->

<!--                           a_2.5 = numeric(), -->

<!--                           a_97.5 = numeric(), -->

<!--                           b = numeric(), -->

<!--                           b_2.5 = numeric(), -->

<!--                           b_97.5 = numeric(), -->

<!--                           AIC = numeric(), -->

<!--                           R2 = numeric(), -->

<!--                           p = numeric(), -->

<!--                           rse = numeric(), -->

<!--                           df = numeric() -->

<!-- ) -->

<!-- for(i in 1:length(vars)) { -->

<!--   var <- vars[i] -->

<!--   loga <- lm(data = merged %>%  -->

<!--                filter(name == var), -->

<!--              k_yr ~ log10(value))  -->

<!--   logarithmic <- logarithmic %>%  -->

<!--     add_row( -->

<!--       mod = 'Logarithmic', -->

<!--       var = var, -->

<!--       a = coef(loga)[1], -->

<!--       a_2.5 = confint(loga)[1], -->

<!--       a_97.5 = confint(loga)[3], -->

<!--       b = coef(loga)[2], -->

<!--       b_2.5 = confint(loga)[2], -->

<!--       b_97.5 = confint(loga)[4], -->

<!--       AIC = AIC(loga), -->

<!--       R2 = summary(loga)$r.squared, -->

<!--       p = summary(loga)$coefficients[8], -->

<!--       rse = summary(loga)$sigma, -->

<!--       df = summary(loga)$df[2] -->

<!--     ) -->

<!-- } -->

<!-- ``` -->

<!-- ```{r logistic, warning=FALSE, echo=TRUE} -->

<!-- ## Logistic: Y ~ 1/1+exp(X) -->

<!-- logistic <- data.frame(mod = character(), -->

<!--                        var = character(), -->

<!--                        b = numeric(), -->

<!--                        b_2.5 = numeric(), -->

<!--                        b_97.5 = numeric(), -->

<!--                        d = numeric(), -->

<!--                        d_2.5 = numeric(), -->

<!--                        d_97.5 = numeric(), -->

<!--                        e = numeric(), -->

<!--                        e_2.5 = numeric(), -->

<!--                        e_97.5 = numeric(), -->

<!--                        AIC = numeric(), -->

<!--                        rse = numeric(), -->

<!--                        df = numeric()) -->

<!-- for(i in 1:length(vars)){ -->

<!--   var <- vars[i] -->

<!--   logi <- drm(k_yr ~ value,  -->

<!--               data = merged %>%  -->

<!--                 filter(name == var), -->

<!--               fct = L.3()) -->

<!--   logistic <- logistic %>%  -->

<!--     add_row( -->

<!--       mod = 'Logistic', -->

<!--       var = var, -->

<!--       b = coef(logi)[1], -->

<!--       b_2.5 = confint2(logi)['b:(Intercept)',1], -->

<!--       b_97.5 = confint2(logi)['b:(Intercept)',2], -->

<!--       d = coef(logi)[2], -->

<!--       d_2.5 = confint2(logi)['d:(Intercept)',1], -->

<!--       d_97.5 = confint2(logi)['d:(Intercept)',2], -->

<!--       e = coef(logi)[3], -->

<!--       e_2.5 = confint2(logi)['e:(Intercept)',1], -->

<!--       e_97.5 = confint2(logi)['b:(Intercept)',2], -->

<!--       AIC = AIC(logi), -->

<!--       rse = summary(logi)$rseMat[1], -->

<!--       df = summary(logi)$rseMat[2]) -->

<!-- } -->

<!-- ``` -->

<!-- ## Combine and evaluate model fits -->

<!-- ```{r model-comps, warning=FALSE, echo=TRUE} -->

<!-- # combine model outputs -->

<!-- aic_all <- rbind(logistic %>%  -->

<!--                    dplyr::select(mod, var, AIC) %>%  -->

<!--                    mutate(p = NA), -->

<!--                  logarithmic %>%  -->

<!--                    dplyr::select(mod, var, AIC, p), -->

<!--                  linear %>%  -->

<!--                    dplyr::select(mod, var, AIC, p), -->

<!--                  micmen %>%  -->

<!--                    dplyr::select(mod, var, AIC, p)) -->

<!-- best_fits <- aic_all %>%  -->

<!--   arrange(var, -->

<!--           AIC) %>%  -->

<!--   group_by(var) %>%  -->

<!--   dplyr::slice_head(n=1) -->

<!-- aic_wts <- data.frame() -->

<!-- for(i in 1:length(vars)) { -->

<!--   use <- vars[i] -->

<!--   df <- aic_all %>%  -->

<!--     filter(!is.na(AIC), -->

<!--            var %in% use) %>%  -->

<!--     mutate(delAIC = akaike.weights(AIC)$deltaAIC, -->

<!--            weights = akaike.weights(AIC)$weights) -->

<!--   aic_wts <- rbind(aic_wts, df) -->

<!-- } -->

<!-- table3 <- aic_wts %>%  -->

<!--   dplyr::select(var, mod, weights) %>%  -->

<!--   pivot_wider(names_from = var,  -->

<!--               values_from = weights) -->

<!-- table3 -->

<!-- ``` -->

<!-- ```{r pred-k, warning=FALSE, echo=TRUE} -->

<!-- # plot decay rates as a function of chemistry -->

<!-- # add lines for SRP (linear), NH4 (M-M), N:P(M-M), and cond (linear) -->

<!-- merged_preds <- data.frame() -->

<!-- for(i in 1:length(best_fits$var)) { -->

<!--   fit <- best_fits[i,] -->

<!--   type <- pull(fit[1]) -->

<!--   var <- pull(fit[2]) -->

<!--   if(type == 'Logistic'){ -->

<!--     logis <- logistic %>%  -->

<!--       filter(var == !!var) -->

<!--     df <- merged %>%  -->

<!--       filter(name == var) %>%  -->

<!--       mutate(pred_k = logis$d/(1+exp(logis$b*(value - logis$e))), -->

<!--              best_fit = type) -->

<!--   } # end logistic if statement -->

<!--   if(type == 'Linear') { -->

<!--     line <- linear %>%  -->

<!--       filter(var == !!var) -->

<!--     if(line$p <= 0.05){ -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = line$a + (value*line$b), -->

<!--                best_fit = type) -->

<!--     } else { -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = NA, -->

<!--                best_fit = NA) -->

<!--     } -->

<!--   } # end linear if statement -->

<!--   if(type == 'Michaelis-Menten'){ -->

<!--     mm <- micmen %>%  -->

<!--       filter(var == !!var) -->

<!--     if(mm$p <= 0.05){ -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = (mm$a*value)/(value + mm$b), -->

<!--                best_fit = type) -->

<!--     } else { -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = NA, -->

<!--                best_fit = NA) -->

<!--     } -->

<!--   } # end M-M for loop -->

<!--   if(type == 'Logarithmic'){ -->

<!--     logar <- logarithmic %>%  -->

<!--       filter(var == !!var) -->

<!--     if(logar$p <= 0.05) { -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = logar$a + (logar$b*value), -->

<!--                best_fit = type) -->

<!--     } else { -->

<!--       df <- merged %>%  -->

<!--         filter(name == var) %>%  -->

<!--         mutate(pred_k = NA, -->

<!--                best_fit = NA) -->

<!--     } -->

<!--   } # end logarithmic if statement -->

<!--   merged_preds <- rbind(merged_preds, df) -->

<!-- } # end for loop -->

<!-- fig3 <- ggplot(merged_preds)+ -->

<!--   geom_point(aes(x = value, -->

<!--                  y = k_yr, -->

<!--                  color = site), -->

<!--              size = 4)+ -->

<!--   geom_line(aes(x = value,  -->

<!--                 y = pred_k), -->

<!--             size = 1, -->

<!--             linetype = 'dashed')+ -->

<!--   ylab(expression(paste(k[wood], ' (', y^-1,')')))+ -->

<!--   facet_wrap(. ~ name, -->

<!--              nrow = 2, -->

<!--              scales = 'free', -->

<!--              labeller = as_labeller(names_long), -->

<!--              drop = FALSE)+ -->

<!--   scale_color_viridis_d(name = 'Site', -->

<!--                         labels = as_labeller(sites_long))+ -->

<!--   theme(axis.title.x = element_blank(), -->

<!--         legend.background = element_blank(), -->

<!--         legend.box.background = element_rect(colour = "black")) -->

<!-- shift_legend2 <- function(p) { -->

<!--   # ... -->

<!--   # to grob -->

<!--   gp <- ggplotGrob(p) -->

<!--   facet.panels <- grep("^panel", gp[["layout"]][["name"]]) -->

<!--   empty.facet.panels <- sapply(facet.panels, function(i) "zeroGrob" %in% class(gp[["grobs"]][[i]])) -->

<!--   empty.facet.panels <- facet.panels[empty.facet.panels] -->

<!--   # establish name of empty panels -->

<!--   empty.facet.panels <- gp[["layout"]][empty.facet.panels, ] -->

<!--   names <- empty.facet.panels$name -->

<!--   # example of names: -->

<!--   #[1] "panel-3-2" "panel-3-3" -->

<!--   # now we just need a simple call to reposition the legend -->

<!--   lemon::reposition_legend(p, 'center', panel = names) -->

<!-- } -->

<!-- fig3 <- shift_legend2(fig3) -->

<!-- ggsave(plot = fig3,  -->

<!--        'Figures/fig3.png',  -->

<!--        dpi = 600,  -->

<!--        width = 11,height = 5) -->

<!-- ``` -->

# Macroinvertebrate analysis

```{r load-bug-data, warning=FALSE, echo=TRUE}
data <- readxl::read_excel('Data/Samples_Nick_ana_2024.xlsx',
                           sheet = 'Data')

data$Stream <- forcats::fct_relevel(data$Stream,
                                    c('Arboleda 30', 'Sura 30', 'Saltito 60',
                                      'Piper', 'Taconazo 30'))

# clean the data
tax_data_clean <- data %>% 
  dplyr::mutate(month = as.numeric(gsub(".*?([0-9]+).*", "\\1", Sample)),
                rep = gsub("\\d+", "", Sample)) %>% 
  dplyr::rename(ffg = `Functional group`) %>% 
  dplyr::filter(QAQC == 0,
                month != 24) 

fig_s7 <- tax_data_clean %>% 
  filter(!is.na(ffg)) %>% 
  group_by(ffg) %>% 
  summarise(total_ffg = sum(Total, na.rm = TRUE)) %>% 
  ggplot(.,
         aes(x = ffg, 
             y = total_ffg))+
  geom_bar(stat = 'identity')+
  geom_label(aes(label = total_ffg))+
  scale_y_log10()+
  labs(x = element_blank(),
       y = 'Total Abundance')+
  theme(axis.text.x = element_text(size = 8))

ggsave(plot = fig_s7,
       'Figures/fig_s7.png',
       dpi = 600,
       height = 4, width = 9)

tot_macros <- sum(tax_data_clean$Total)
threshold <- tot_macros*0.01

# main FFGS: at least 1% of all FFGs identified
main_ffgs <- tax_data_clean %>% 
  dplyr::group_by(ffg) %>% 
  dplyr::summarise(n = sum(Total)) %>% 
  dplyr::filter(n > threshold) %>% 
  dplyr::pull(ffg)

```

```{r bug-stats, warning=FALSE, echo=TRUE}

final_dry_mass <- readr::read_csv('Data/final_dry_mass.csv')

final_dry_mass$site <- dplyr::recode_factor(final_dry_mass$site,
                                            Arb = 'Arboleda 30',
                                            Sur30 = 'Sura 30',
                                            Tito60 = 'Saltito 60',
                                            Piper = 'Piper',
                                            Tac = 'Taconazo 30')


macro_density <- tax_data_clean %>% 
  dplyr::filter(!is.na(order)) %>%                               # remove NAs from Order
  dplyr::select(site = Stream, Family, month, rep, Total) %>%     # get the necessary columns
  dplyr::group_by(site, month, rep) %>%                          # and do the grouping
  dplyr::summarise(total_family = sum(Total)) %>% 
  dplyr::left_join(final_dry_mass,
                   by = c('site', 'month', 'rep')) %>% 
  dplyr::mutate(abund_per_dm = total_family/dry_mass)

macro_density_sum <- macro_density %>% 
  group_by(site, month) %>% 
  summarise(mean_den = mean(abund_per_dm, na.rm = TRUE),
            se_den = sd(abund_per_dm, na.rm = TRUE)/length(mean_den))

fig3 <- ggplot(macro_density_sum,
               aes(x = month,
                   y = mean_den,
                   color = site,
                   group = site))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin = mean_den - se_den,
                    ymax = mean_den + se_den),
                width = 0)+
  scale_x_continuous(breaks = c(0, 1, 3, 6, 12))+
  labs(y = expression(paste('Mean macroinvertebrate density (# g   ',DM^-1,')')),
       x = 'Months in Stream')+
  scale_color_viridis_d(name = 'Site')+
  theme(axis.title = element_text(size = 12))
fig3


ggsave(plot = fig3, 
       'Figures/fig3.png', 
       dpi = 600, 
       width = 6, height = 4)


macro_density_ffg <- tax_data_clean %>% 
  dplyr::filter(!is.na(order)) %>%                               # remove NAs from Order
  dplyr::select(site = Stream, ffg, month, rep, Total) %>%     # get the necessary columns
  dplyr::group_by(site, month, ffg, rep) %>%                          # and do the grouping
  dplyr::summarise(total_family = sum(Total))

macro_density_sum_ffg <- macro_density_ffg %>% 
  group_by(site, month, ffg) %>% 
  summarise(mean_abund = mean(total_family, na.rm = TRUE),
            se_abund = sd(total_family, na.rm = TRUE)/length(mean_abund))

fig4 <- ggplot(macro_density_sum_ffg %>% 
                 dplyr::filter(!is.na(ffg),
                               ffg %in% main_ffgs),
               aes(x = month,
                   y = mean_abund,
                   color = site))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin = mean_abund - se_abund,
                    ymax = mean_abund + se_abund),
                width = 0)+
  # geom_boxplot()+
  facet_wrap(ffg ~ .,
             scales = 'free_y')+
  scale_color_viridis_d(name = 'Site')+
  scale_x_continuous(breaks = c(1, 3, 6, 12))+
  scale_y_continuous(breaks = function(y) {
    max_value <- max(y, na.rm = TRUE)
    tick_marks <- seq(0, round(max_value*.75, -1), length.out = 3)
    return(tick_marks)
  })+
  labs(y = expression(paste('Mean FFG Abundance (#)')),
       x = 'Months in Stream')+
  theme(axis.title = element_text(size = 12))
fig4

# fig4_b <- shift_legend2(fig4_b)

ggsave(plot = fig4, 
       'Figures/fig4.png', 
       dpi = 600, 
       width = 6, height = 4)

macro_density_mod <- macro_density %>% 
  dplyr::mutate(log_abund = log10(abund_per_dm)) %>% 
  dplyr::filter(is.finite(log_abund))

macro_lm <- lm(data = macro_density_mod %>% 
                 dplyr::filter(is.finite(abund_per_dm)),
               log_abund ~ factor(month) * site)

summary(macro_lm)
anova(macro_lm)
hist(macro_lm$residuals)
(agricolae::HSD.test(macro_lm, 'site'))

```

```{r NMDS, warning=FALSE, echo=TRUE}
tax_data_clean_family_log <- tax_data_clean %>% 
  dplyr::filter(!is.na(Family)) %>%                               # remove NAs from Order
  dplyr::select(Stream, Family, month, rep, Total) %>%    # get the necessary columns
  dplyr::group_by(Stream, month, Family) %>%         # and do the grouping
  dplyr::summarise(mean_family = mean(Total, na.rm = TRUE)) %>%   # sum by order in each possible grouping 
  dplyr::mutate(log_total = log10(1 + mean_family)) %>%          # log10 + 1 transform data
  dplyr::select(-mean_family) %>% 
  tidyr::pivot_wider(names_from = Family,                         # pivot data
                     values_from = log_total,
                     values_fill = 0)

tax_data_log_matrix_fam <- tax_data_clean_family_log[,-c(1:2)]
tax_data_log_meta_fam <- tax_data_clean_family_log[,c(1:2)]

nmds_family_log_2d <- vegan::metaMDS(tax_data_log_matrix_fam,
                                     distance = 'bray',
                                     k = 2,
                                     autotransform = FALSE)

stress_fam_log_2d <- round(nmds_family_log_2d$stress, 3)

# pick the log transformed 2d NMDS (14.4% stress)

nmds_family_out <- data.frame(x = nmds_family_log_2d$points[,1],
                              y = nmds_family_log_2d$points[,2])

nmds_family_out <- cbind(tax_data_log_meta_fam,
                         nmds_family_out)

fit_fam <- (vegan::envfit(nmds_family_log_2d,
                          tax_data_log_matrix_fam,
                          perm = 9999))

scrs_fam <- data.frame(vegan::scores(fit_fam, 'vectors'))

scrs_fam$pvals <- fit_fam$vectors$pvals

scrs_fam_sig <- subset(scrs_fam, pvals <= 0.05)

scrs_fam_sig$env.variables <- row.names(scrs_fam_sig)


plot_nmds_family_scrs <- ggplot(nmds_family_out,
                                aes(x = x, y = y))+
  geom_point(size = 2)+
  geom_segment(data = scrs_fam_sig,
               aes(x = 0, xend = NMDS1,
                   y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, 'cm')),
               color = 'black')+
  ggrepel::geom_label_repel(data = scrs_fam_sig,
                            aes(NMDS1, NMDS2,
                                label = env.variables),
                            size = 3)+
  labs(x = 'NMDS 1',
       y = 'NMDS 2')
# lims(x = c(-1,1),
#      y = c(-0.75, 0.75))+
plot_nmds_family_scrs


source('Code/veganCovEllipse.R')
streams <- data.frame()
for(i in unique(nmds_family_out$Stream)){
  streams <- rbind(streams,
                   cbind(
                     as.data.frame(
                       with(nmds_family_out[nmds_family_out$Stream == i,],
                            veganCovEllipse(cov.wt(cbind(x, y),
                                                   wt = rep(1/length(x),
                                                            length(x)))$cov,
                                            center = c(mean(x),
                                                       mean(y)
                                            )
                            )
                       )
                     ), 
                     Stream = i)
  )
} # end for loop

plot_nmds_streams <- ggplot(data = nmds_family_out,
                            aes(x = x, y = y))+
  geom_point(aes(color = Stream),
             size = 2)+
  geom_path(data = streams,
            linewidth = 1,
            aes(x = x, y = y, color = Stream))+
  labs(x = "NMDS 1", 
       y = "NMDS 2")+
  lims(x = c(-1,1),
       y = c(-0.75,0.75))+
  theme(legend.background = element_blank())+
  scale_color_viridis_d(name = element_blank())+
  geom_label(label = paste('2D Stress = ', stress_fam_log_2d),
             x = -0.6,
             y = -0.65)
plot_nmds_streams

fig5 <- ggpubr::ggarrange(plot_nmds_family_scrs,
                          plot_nmds_streams,
                          align = 'h', 
                          widths = c(1,1.25),
                          labels = 'auto',
                          label.x = c(0.18,0.13),
                          label.y = 0.98)
fig5

ggsave(plot = fig5, 
       'Figures/fig5.png', 
       dpi = 600, 
       width = 11.5,height = 4)

# Permanova
# The goal of this test is to tell you if there are significant differences in your response variables among your groupings
permanova <- vegan::adonis2(tax_data_log_matrix_fam ~ Stream * month, 
                            data = tax_data_log_meta_fam, 
                            permutations = 9999, 
                            method = 'bray', 
                            by = 'terms')
permanova

# SIMPER
sim <- with(tax_data_log_meta_fam, 
            vegan::simper(tax_data_log_matrix_fam, Stream))

summary(sim)

simper_use <- do.call(rbind, summary(sim)) %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(comparison = strsplit(rowname, "[.]")[[1]][1],
                family = strsplit(rowname, "[.]")[[1]][2]) %>% 
  dplyr::select(-rowname)

simper_sig <- simper_use %>% 
  dplyr::filter(p <= 0.05) %>% 
  dplyr::group_by(comparison, family) %>% 
  dplyr::summarise(n_sig = length(p),
                   mean_avg = mean(average, na.rm = TRUE)) 


table_s2 <- simper_use %>% 
  dplyr::filter(p <= 0.05) %>% 
  dplyr::group_by(comparison, family)

table_s2[,-c(8:9)] <- round(table_s2[,-c(8:9)],
                            digits = 2)

# ANOSIM
anosim <- vegan::anosim(tax_data_log_matrix_fam,
                        grouping = tax_data_log_meta_fam$Stream,
                        distance = 'bray',
                        permutations = 9999)
summary(anosim)
anosim_r <- anosim$statistic
anosim_p <- anosim$signif
```

# Session Info

```{r session-info}
pander(sessionInfo())
```
